#include "include/challenge.h"

char *too_easy = "too_easy";
static char hidden_section[] __attribute__((section(".RUN_ME"))) = {0};

char * animal = 
 "_______________________\n"
"< ESTO ES UN EASTER_EGG >\n"
 "-----------------------\n"
        "     \\  ^__^\n"
         "     \\  (oo)\\_______\n"
            "        (__)\\       )\\/\\ \n"
                 "            ||----w |\n"
                 "            ||     ||";

int challenge_amount = NONE;
challenge_ts challenge_table[_CHALLENGE_AMOUNT];

char *challenges[_CHALLENGE_AMOUNT] = {
    (char []){0x63,0x8A,0x86,0x8F,0x97,0x86,0x8F,0x8A,0x85,0x90,0x94,0x41,0x82,0x8D,0x41,0x75,0x71,0x54,0x41,0x9A,0x41,0x87,0x86,0x8D,0x8A,0x84,0x8A,0x95,0x82,0x84,0x8A,0x90,0x8F,0x86,0x94,0x4D,0x41,0x9A,0x82,0x41,0x93,0x86,0x94,0x90,0x8D,0x97,0x8A,0x86,0x93,0x90,0x8F,0x41,0x86,0x8D,0x41,0x91,0x93,0x8A,0x8E,0x86,0x93,0x41,0x82,0x84,0x86,0x93,0x95,0x8A,0x8B,0x90,0x4F,0x2B,0x2B,0x66,0x8F,0x41,0x86,0x94,0x95,0x86,0x41,0x75,0x71,0x41,0x85,0x86,0x83,0x86,0x93,0xE4,0xC2,0x8F,0x41,0x87,0x8A,0x8F,0x82,0x8D,0x8A,0x9B,0x82,0x93,0x41,0x86,0x8D,0x41,0x8B,0x96,0x86,0x88,0x90,0x41,0x92,0x96,0x86,0x41,0x9A,0x82,0x41,0x84,0x90,0x8E,0x86,0x8F,0x9B,0x82,0x93,0x90,0x8F,0x41,0x93,0x86,0x94,0x90,0x8D,0x97,0x8A,0x86,0x8F,0x85,0x90,0x41,0x8D,0x90,0x94,0x41,0x85,0x86,0x94,0x82,0x87,0xE4,0xCE,0x90,0x94,0x41,0x85,0x86,0x41,0x84,0x82,0x85,0x82,0x41,0x8F,0x8A,0x97,0x86,0x8D,0x4F,0x2B,0x62,0x85,0x86,0x8E,0xE4,0xC2,0x94,0x41,0x95,0x86,0x8F,0x85,0x93,0xE4,0xC2,0x8F,0x41,0x92,0x96,0x86,0x41,0x8A,0x8F,0x97,0x86,0x94,0x95,0x8A,0x88,0x82,0x93,0x41,0x90,0x95,0x93,0x82,0x94,0x41,0x91,0x93,0x86,0x88,0x96,0x8F,0x95,0x82,0x94,0x41,0x91,0x82,0x93,0x82,0x41,0x93,0x86,0x94,0x91,0x90,0x8F,0x85,0x86,0x93,0x41,0x85,0x96,0x93,0x82,0x8F,0x95,0x86,0x41,0x8D,0x82,0x41,0x85,0x86,0x87,0x86,0x8F,0x94,0x82,0x4F,0x2B,0x66,0x8D,0x41,0x85,0x86,0x94,0x82,0x87,0xE4,0xCE,0x90,0x41,0x87,0x8A,0x8F,0x82,0x8D,0x41,0x84,0x90,0x8F,0x94,0x8A,0x94,0x95,0x86,0x41,0x86,0x8F,0x41,0x84,0x93,0x86,0x82,0x93,0x41,0x96,0x8F,0x41,0x91,0x93,0x90,0x88,0x93,0x82,0x8E,0x82,0x41,0x92,0x96,0x86,0x41,0x94,0x86,0x41,0x84,0x90,0x8E,0x91,0x90,0x93,0x95,0x86,0x41,0x8A,0x88,0x96,0x82,0x8D,0x41,0x92,0x96,0x86,0x41,0x9A,0x90,0x4D,0x41,0x86,0x94,0x41,0x85,0x86,0x84,0x8A,0x93,0x4D,0x41,0x92,0x96,0x86,0x41,0x91,0x93,0x90,0x97,0x86,0x82,0x41,0x8D,0x90,0x94,0x41,0x8E,0x8A,0x94,0x8E,0x90,0x94,0x41,0x85,0x86,0x94,0x82,0x87,0xE4,0xCE,0x90,0x94,0x41,0x9A,0x41,0x92,0x96,0x86,0x41,0x94,0x86,0x82,0x41,0x8F,0x86,0x84,0x86,0x94,0x82,0x93,0x8A,0x90,0x41,0x89,0x82,0x84,0x86,0x93,0x41,0x8D,0x90,0x41,0x8E,0x8A,0x94,0x8E,0x90,0x41,0x91,0x82,0x93,0x82,0x41,0x93,0x86,0x94,0x90,0x8D,0x97,0x86,0x93,0x8D,0x90,0x94,0x4F,0x41,0x6F,0x90,0x41,0x83,0x82,0x94,0x95,0x82,0x41,0x84,0x90,0x8F,0x41,0x86,0x94,0x91,0x86,0x93,0x82,0x93,0x41,0x8D,0x82,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x4F,0x2B,0x62,0x85,0x86,0x8E,0xE4,0xC2,0x94,0x4D,0x41,0x85,0x86,0x83,0x86,0x93,0xE4,0xC2,0x8F,0x41,0x8A,0x8E,0x91,0x8D,0x86,0x8E,0x86,0x8F,0x95,0x82,0x93,0x41,0x90,0x95,0x93,0x90,0x41,0x91,0x93,0x90,0x88,0x93,0x82,0x8E,0x82,0x41,0x91,0x82,0x93,0x82,0x41,0x84,0x90,0x8E,0x96,0x8F,0x8A,0x84,0x82,0x93,0x94,0x86,0x41,0x84,0x90,0x8F,0x8E,0x8A,0x88,0x90,0x4F,0x2B,0x2B,0x65,0x86,0x83,0x86,0x93,0xE4,0xC2,0x8F,0x41,0x86,0x94,0x95,0x82,0x93,0x41,0x82,0x95,0x86,0x8F,0x95,0x90,0x94,0x41,0x82,0x41,0x8D,0x90,0x94,0x41,0x86,0x82,0x94,0x95,0x86,0x93,0x41,0x86,0x88,0x88,0x94,0x4F,0x2B,0x2B,0x71,0x82,0x93,0x82,0x41,0x97,0x86,0x93,0x8A,0x87,0x8A,0x84,0x82,0x93,0x41,0x92,0x96,0x86,0x41,0x94,0x96,0x94,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x94,0x41,0x95,0x8A,0x86,0x8F,0x86,0x8F,0x41,0x86,0x8D,0x41,0x87,0x90,0x93,0x8E,0x82,0x95,0x90,0x41,0x84,0x90,0x93,0x93,0x86,0x84,0x95,0x90,0x41,0x93,0x86,0x94,0x91,0x90,0x8F,0x85,0x82,0x8F,0x41,0x82,0x41,0x86,0x94,0x95,0x86,0x41,0x85,0x86,0x94,0x82,0x87,0xE4,0xCE,0x90,0x41,0x84,0x90,0x8F,0x41,0x8D,0x82,0x41,0x91,0x82,0x8D,0x82,0x83,0x93,0x82,0x41,0x48,0x86,0x8F,0x95,0x86,0x8F,0x85,0x8A,0x85,0x90,0x7D,0x8F,0x48,0x21,0x0,0x0,0x0,0x0},
    (char []){0x75,0x89,0x86,0x41,0x78,0x8A,0x93,0x86,0x41,0x74,0x52,0x66,0x56,0x2B,0x56,0x53,0x5A,0x56,0x41,0x59,0x59,0x59,0x41,0x57,0x53,0x59,0x59,0x21,0x0,0x0,0x0,0x0},
    (char []){0x89,0x95,0x95,0x91,0x94,0x5B,0x50,0x50,0x8A,0x83,0x83,0x4F,0x84,0x90,0x50,0x95,0x84,0x51,0x69,0x83,0x57,0x98,0x21,0x0},
    (char []){0x66,0x63,0x62,0x65,0x67,0x4f,0x4f,0x4f,0x2b,0x21},
    (char []){0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x41,0x5E,0x41,0x94,0x95,0x93,0x8A,0x8F,0x88,0x94,0x5B,0x53,0x54,0x56,0x21},
    (char []){0x4f,0x85,0x82,0x95,0x82,0x41,0x60,0x41,0x4f,0x83,0x94,0x94,0x41,0x4f,0x84,0x90,0x8e,0x8e,0x86,0x8f,0x95,0x41,0x4f,0x94,0x89,0x94,0x95,0x93,0x95,0x82,0x83,0x41,0x4f,0x94,0x9a,0x8e,0x95,0x82,0x83,0x41,0x4f,0x94,0x95,0x93,0x95,0x82,0x83,0x2b,0x21},
    (char []){0x67,0x8A,0x8D,0x95,0x86,0x93,0x41,0x86,0x93,0x93,0x90,0x93,0x21,0x0},
    (char []){0xE3,0xE0,0x60,0x21},
    (char []){0x6D,0x82,0x95,0x86,0x99,0x8E,0x86,0x2b,0x74,0x8a,0x2b,0x7d,0x8e,0x82,0x95,0x89,0x93,0x8e,0x9c,0x85,0x9e,0x9a,0x41,0x5e,0x41,0x96,0x7f,0x97,0x9c,0x7d,0x84,0x85,0x90,0x95,0x9e,0x49,0x97,0x48,0x9c,0x7d,0x84,0x85,0x90,0x95,0x9e,0x7d,0x8d,0x8f,0x9c,0x49,0x96,0x4a,0x9e,0x4c,0x97,0x9c,0x7d,0x84,0x85,0x90,0x95,0x9e,0x7d,0x87,0x93,0x82,0x84,0x9c,0x96,0x48,0x9e,0x9c,0x96,0x9e,0x4a,0x2b,0x86,0x8f,0x95,0x90,0x8f,0x84,0x86,0x94,0x2b,0x9a,0x41,0x5e,0x41,0x2b,0x21},
    (char []){0x92,0x96,0x8A,0x8F,0x86,0x21},
    (char []){0x83,0x41,0x88,0x85,0x83,0x8E,0x86,0x41,0x9A,0x41,0x86,0x8F,0x84,0x90,0x8F,0x95,0x93,0xE4,0xC2,0x41,0x86,0x8D,0x41,0x97,0x82,0x8D,0x90,0x93,0x41,0x8E,0xE4,0xC2,0x88,0x8A,0x84,0x90,0x21},
    (char []){0x6E,0x86,0x41,0x84,0x90,0x8F,0x90,0x84,0x86,0x94,0x21,0x0}
};

char *questions[_CHALLENGE_AMOUNT] = {
    (char []){0xE3,0xE0,0x64,0xE4,0xD4,0x8E,0x90,0x41,0x85,0x86,0x94,0x84,0x96,0x83,0x93,0x8A,0x86,0x93,0x90,0x8F,0x41,0x86,0x8D,0x41,0x91,0x93,0x90,0x95,0x90,0x84,0x90,0x8D,0x90,0x4D,0x41,0x8D,0x82,0x41,0x85,0x8A,0x93,0x86,0x84,0x84,0x8A,0xE4,0xD4,0x8F,0x41,0x9A,0x41,0x86,0x8D,0x41,0x91,0x96,0x86,0x93,0x95,0x90,0x41,0x91,0x82,0x93,0x82,0x41,0x84,0x90,0x8F,0x86,0x84,0x95,0x82,0x93,0x94,0x86,0x60,0x21},
    (char []){0xE3,0xE0,0x72,0x96,0xE4,0xCA,0x41,0x85,0x8A,0x87,0x86,0x93,0x86,0x8F,0x84,0x8A,0x82,0x94,0x41,0x89,0x82,0x9A,0x41,0x86,0x8F,0x95,0x93,0x86,0x41,0x75,0x64,0x71,0x41,0x9A,0x41,0x76,0x65,0x71,0x41,0x9A,0x41,0x86,0x8F,0x41,0x92,0x96,0xE4,0xCA,0x41,0x84,0x82,0x94,0x90,0x94,0x41,0x84,0x90,0x8F,0x97,0x8A,0x86,0x8F,0x86,0x41,0x96,0x94,0x82,0x93,0x41,0x84,0x82,0x85,0x82,0x41,0x96,0x8F,0x90,0x60,0x21},
    (char []){0xE3,0xE0,0x66,0x8D,0x41,0x91,0x96,0x86,0x93,0x95,0x90,0x41,0x92,0x96,0x86,0x41,0x96,0x94,0x82,0x93,0x90,0x8F,0x41,0x91,0x82,0x93,0x82,0x41,0x84,0x90,0x8F,0x86,0x84,0x95,0x82,0x93,0x94,0x86,0x41,0x82,0x8D,0x41,0x94,0x86,0x93,0x97,0x86,0x93,0x41,0x86,0x94,0x41,0x86,0x8D,0x41,0x8E,0x8A,0x94,0x8E,0x90,0x41,0x92,0x96,0x86,0x41,0x96,0x94,0x82,0x8F,0x41,0x91,0x82,0x93,0x82,0x41,0x8E,0x82,0x8F,0x85,0x82,0x93,0x41,0x8D,0x82,0x94,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x94,0x60,0x41,0xE3,0xE0,0x71,0x90,0x93,0x41,0x92,0x96,0xE4,0xCA,0x60,0x21},
    (char []){0xE3,0xE0,0x72,0x96,0xE4,0xCA,0x41,0xE4,0xDB,0x95,0x8A,0x8D,0x41,0x82,0x83,0x94,0x95,0x93,0x82,0x84,0x84,0x8A,0xE4,0xD4,0x8F,0x41,0x86,0x94,0x41,0x96,0x95,0x8A,0x8D,0x8A,0x9B,0x82,0x85,0x82,0x41,0x91,0x82,0x93,0x82,0x41,0x84,0x90,0x8E,0x96,0x8F,0x8A,0x84,0x82,0x93,0x94,0x86,0x41,0x84,0x90,0x8F,0x41,0x94,0x90,0x84,0x8C,0x86,0x95,0x94,0x60,0x41,0xE3,0xE0,0x94,0x86,0x41,0x91,0x96,0x86,0x85,0x86,0x41,0x96,0x95,0x8A,0x8D,0x8A,0x9B,0x82,0x93,0x41,0x93,0x86,0x82,0x85,0x49,0x53,0x4A,0x41,0x9A,0x41,0x98,0x93,0x8A,0x95,0x86,0x49,0x53,0x4A,0x41,0x91,0x82,0x93,0x82,0x41,0x90,0x91,0x86,0x93,0x82,0x93,0x60,0x21},
    (char []){0xE3,0xE0,0x64,0xE4,0xD4,0x8E,0x90,0x41,0x88,0x82,0x93,0x82,0x8F,0x95,0x8A,0x9B,0x82,0x41,0x75,0x64,0x71,0x41,0x92,0x96,0x86,0x41,0x8D,0x90,0x94,0x41,0x91,0x82,0x92,0x96,0x86,0x95,0x86,0x94,0x41,0x8D,0x8D,0x86,0x88,0x82,0x8F,0x41,0x86,0x8F,0x41,0x90,0x93,0x85,0x86,0x8F,0x41,0x9A,0x41,0x8F,0x90,0x41,0x94,0x86,0x41,0x91,0x8A,0x86,0x93,0x85,0x86,0x8F,0x60,0x21},
    (char []){0x76,0x8F,0x41,0x94,0x86,0x93,0x97,0x8A,0x85,0x90,0x93,0x41,0x94,0x96,0x86,0x8D,0x86,0x41,0x84,0x93,0x86,0x82,0x93,0x41,0x96,0x8F,0x41,0x8F,0x96,0x86,0x97,0x90,0x41,0x91,0x93,0x90,0x84,0x86,0x94,0x90,0x41,0x90,0x41,0x95,0x89,0x93,0x86,0x82,0x85,0x41,0x91,0x82,0x93,0x82,0x41,0x82,0x95,0x86,0x8F,0x85,0x86,0x93,0x41,0x8D,0x82,0x94,0x41,0x84,0x90,0x8F,0x86,0x99,0x8A,0x90,0x8F,0x86,0x94,0x41,0x86,0x8F,0x95,0x93,0x82,0x8F,0x95,0x86,0x94,0x4F,0x41,0xE3,0xE0,0x72,0x96,0xE4,0xCA,0x41,0x84,0x90,0x8F,0x97,0x8A,0x86,0x8F,0x86,0x41,0x8E,0xE4,0xC2,0x94,0x60,0x21},
    (char []){0xE3,0xE0,0x64,0xE4,0xD4,0x8E,0x90,0x41,0x94,0x86,0x41,0x91,0x96,0x86,0x85,0x86,0x41,0x8A,0x8E,0x91,0x8D,0x86,0x8E,0x86,0x8F,0x95,0x82,0x93,0x41,0x96,0x8F,0x41,0x94,0x86,0x93,0x97,0x8A,0x85,0x90,0x93,0x41,0x92,0x96,0x86,0x41,0x82,0x95,0x8A,0x86,0x8F,0x85,0x82,0x41,0x8E,0x96,0x84,0x89,0x82,0x94,0x41,0x84,0x90,0x8F,0x86,0x99,0x8A,0x90,0x8F,0x86,0x94,0x41,0x94,0x8A,0x8F,0x41,0x96,0x94,0x82,0x93,0x41,0x91,0x93,0x90,0x84,0x86,0x94,0x90,0x94,0x41,0x8F,0x8A,0x41,0x95,0x89,0x93,0x86,0x82,0x85,0x94,0x60,0x21},
    (char []){0xE3,0xE0,0x72,0x96,0xE4,0xCA,0x41,0x82,0x91,0x8D,0x8A,0x84,0x82,0x84,0x8A,0x90,0x8F,0x86,0x94,0x41,0x94,0x86,0x41,0x91,0x96,0x86,0x85,0x86,0x8F,0x41,0x96,0x95,0x8A,0x8D,0x8A,0x9B,0x82,0x93,0x41,0x91,0x82,0x93,0x82,0x41,0x97,0x86,0x93,0x41,0x86,0x8D,0x41,0x95,0x93,0xE4,0xC2,0x87,0x8A,0x84,0x90,0x41,0x91,0x90,0x93,0x41,0x8D,0x82,0x41,0x93,0x86,0x85,0x60,0x21},
    (char []){0x94,0x90,0x84,0x8C,0x86,0x95,0x94,0x41,0x86,0x94,0x41,0x96,0x8F,0x41,0x8E,0x86,0x84,0x82,0x8F,0x8A,0x94,0x8E,0x90,0x41,0x85,0x86,0x41,0x6A,0x71,0x64,0x4F,0x41,0xE3,0xE0,0x72,0x96,0xE4,0xCA,0x41,0x86,0x94,0x41,0x8E,0xE4,0xC2,0x94,0x41,0x86,0x87,0x8A,0x84,0x8A,0x86,0x8F,0x95,0x86,0x41,0x86,0x8F,0x95,0x93,0x86,0x41,0x94,0x90,0x84,0x8C,0x86,0x95,0x94,0x41,0x9A,0x41,0x91,0x8A,0x91,0x86,0x94,0x60,0x21},
    (char []){0xE3,0xE0,0x64,0x96,0xE4,0xC2,0x8D,0x86,0x94,0x41,0x94,0x90,0x8F,0x41,0x8D,0x82,0x94,0x41,0x84,0x82,0x93,0x82,0x84,0x95,0x86,0x93,0xE4,0xCE,0x94,0x95,0x8A,0x84,0x82,0x94,0x41,0x85,0x86,0x8D,0x41,0x91,0x93,0x90,0x95,0x90,0x84,0x90,0x8D,0x90,0x41,0x74,0x64,0x75,0x71,0x60,0x21},
    (char []){0xE3,0xE0,0x72,0x96,0xE4,0xCA,0x41,0x86,0x94,0x41,0x96,0x8F,0x41,0x73,0x67,0x64,0x60,0x21},
    (char []){0xE3,0xE0,0x67,0x96,0x86,0x41,0x85,0x8A,0x97,0x86,0x93,0x95,0x8A,0x85,0x90,0x60,0x21}
};

char *flags[_CHALLENGE_AMOUNT] = {
    "f959505ee0c9d7fb7d81a0904aa4e9f4",
    "244f7439f45f207f1eb89fb2344a4767",
    "d4daf850c3fcce947992440e3c17dd82",
    "53b04de7d6d99df86aa0289418f2b317",
    "ce0c1111d26e426e0ea7c1f58d5488fe",
    "752435d46843b72130c3b0b3bc1220d4",
    "d281db859d7ca31e15551150a10d20ad",
    "e09635a04dc73332ceb8f2488c7eea1a",
    "5473c71236bfb255256bc59958fb165a",
    "c2fb1566098f29ce6b5048fcd6aad77c",
    "869c4f21dcb4e24138d4a016ed000939",
    "fea087517c26fadd409bd4b9dc642555"
};

void challenge_register(char *challenge, char *question, challenge_func fn, char *flag) {
    char dec_challenge[BIG_BUFFER_SIZE];
    char dec_question[BIG_BUFFER_SIZE];
    decrypt(dec_challenge, challenge, BIG_BUFFER_SIZE);
    decrypt(dec_question, question, BIG_BUFFER_SIZE);
    strcpy(challenge_table[challenge_amount].challenge_question, dec_question);
    strcpy(challenge_table[challenge_amount].challenge, dec_challenge);
    strcpy(challenge_table[challenge_amount].challenge_flag, flag);
    challenge_table[challenge_amount].fn = fn;
    challenge_amount++;
}


void bad_fd_challenge() {
    char enc[] = {  0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,
                    0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F,0x4F, 0x4F,0x4F,
                    0x4F,0x4F,0x6D, 0x82,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x41,
                    0x86,0x94,0x41,0x87,0x8C,0x54,0x98,0x87,0x6D,0x64,0x8E, 0x54,0x72,0x97,0x74,
                    0x2B,0x21};
    char answer[SMALL_BUFFER_SIZE];
    decrypt(answer, enc, SMALL_BUFFER_SIZE);
    if(write(BAD_FD, answer, 61) == -1) {
        perror("write");
    }
}

void kill_tracer() {
    unsigned int pid = getpid();
    
    char enc[] = {  0x88,0x93,0x86,0x91,0x41,0x75,0x93,0x82,0x84,0x86,0x93,0x41,0x50,0x91,0x93,
                    0x90,0x84,0x50,0x46,0x85,0x50,0x94,0x95,0x82,0x95,0x96,0x94,0x41,0x9D,0x41,
                    0x84,0x96,0x95,0x41,0x4E,0x87,0x41,0x53,0x21,0x0,0x18,0x1E,0x40,0x0,0x0,0x0,
                    0x0,0x0};

    char format[SMALL_BUFFER_SIZE];
    decrypt(format, enc, SMALL_BUFFER_SIZE);
    char command[SMALL_BUFFER_SIZE];
    sprintf(command, format, pid);
    file_ptr out = popen(command, "r");
    if(out == NULL) {
        perror("popen");
        exit(ERROR);
    }
    int tracer_pid = NO_TRACER;
    fscanf(out, "%d", &tracer_pid);
    fclose(out);
    if(tracer_pid != NO_TRACER) kill(tracer_pid, SIGKILL);
}

void filter_error_challenge() {
    kill_tracer();
    time_t t;
    srand((unsigned) time(&t));
    int index = 0;
    char enc[] = {  0x6D,0x82,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,
                    0x41,0x86,0x94,0x41,0x6C,0x56,0x8F,0x53,0x76,0x67,0x87,0x91,
                    0x67,0x6E,0x76,0x6F,0x2B,0x21};
    char answer[SMALL_BUFFER_SIZE];
    decrypt(answer, enc, SMALL_BUFFER_SIZE);
    while(answer[index]) {
        while(rand() % 100 <= 14) {
            char c = answer[index++];
            write(STDOUT_FILENO, &c, 1);
            if(!answer[index]) return;
        }
        char c = (char)(rand() % 95 + 32);
        write(STDERR_FILENO, &c, 1);
    }
}

void curious_easter_egg() {
    // echo QUE CURIOSO> /tmp/hidden
    char enc[] = {  0x86,0x84,0x89,0x90,0x41,0x72,0x76,0x66,0x41,0x64,0x76,0x73,
                    0x6A,0x70,0x74,0x70,0x5F,0x41,0x50,0x95,0x8E,0x91,0x50,0x89,
                    0x8A,0x85,0x85,0x86,0x8F,0x21};
    char command[SMALL_BUFFER_SIZE];
	decrypt(command, enc, SMALL_BUFFER_SIZE);
	system(command);
}

void black_bg_challenge() {
    kill_tracer();
    printf("\e[30;40m");
    char enc[] = {  0x6D,0x82,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x41,
                    0x86,0x94,0x41,0x63,0x76,0x8E,0x9A,0x7A,0x92,0x56,0x79,0x99,0x79,
                    0x68,0x95,0x21};
    char answer[SMALL_BUFFER_SIZE];
    decrypt(answer, enc, SMALL_BUFFER_SIZE);
    printf("%s\n", answer);
    printf("\e[0m");
}

void quine_challenge() {
    char enc_gcc[] = {  0x88,0x84,0x84,0x41,0x92,0x96,0x8A,0x8F,0x86,0x4F,0x84,0x41,0x4E,
                        0x90,0x41,0x92,0x96,0x8A,0x8F,0x86,0x21};
    char gcc[SMALL_BUFFER_SIZE];
    decrypt(gcc, enc_gcc, SMALL_BUFFER_SIZE);
    char enc_retry_msg[]= {  0x66,0x6F,0x75,0x66,0x73,0x41,0x91,0x82,0x93,0x82,0x41,0x93,0x86,
                             0x8A,0x8F,0x95,0x86,0x8F,0x95,0x82,0x93,0x4F,0x21};
    char retry_msg[SMALL_BUFFER_SIZE];
    decrypt(retry_msg, enc_retry_msg, SMALL_BUFFER_SIZE);
    int retry = 1;
    retry = system(gcc);
    if(retry != 0) {
        printf("\n%s\n", retry_msg);
    } else {
        char enc_diff[] = { 0x4F,0x50,0x92,0x96,0x8A,0x8F,0x86,0x41,0x9D,0x41,0x85,0x8A,
                            0x87,0x87,0x41,0x4E,0x41,0x92,0x96,0x8A,0x8F,0x86,0x4F,0x84,
                            0x21};
        char diff[SMALL_BUFFER_SIZE];
        decrypt(diff, enc_diff, SMALL_BUFFER_SIZE);
        char enc_step_msg[] = { 0xE3,0xC2,0x68,0x86,0x8F,0x8A,0x82,0x8D,0x42,0x4D,0x41,0x9A,
                                0x82,0x41,0x8D,0x90,0x88,0x93,0x82,0x93,0x90,0x8F,0x41,0x8E,
                                0x86,0x95,0x86,0x93,0x41,0x96,0x8F,0x41,0x91,0x93,0x90,0x88,
                                0x93,0x82,0x8E,0x82,0x41,0x86,0x8F,0x41,0x92,0x96,0x8A,0x8F,
                                0x86,0x4F,0x84,0x4D,0x41,0x97,0x86,0x82,0x8E,0x90,0x94,0x41,
                                0x94,0x8A,0x41,0x89,0x82,0x84,0x86,0x41,0x8D,0x90,0x41,0x92,
                                0x96,0x86,0x41,0x84,0x90,0x93,0x93,0x86,0x94,0x91,0x90,0x8F,
                                0x85,0x86,0x4F,0x21};
        char step_msg[SMALL_BUFFER_SIZE];
        decrypt(step_msg, enc_step_msg, SMALL_BUFFER_SIZE);
        printf("%s\n", step_msg);
        retry = system(diff);
        if(retry != 0) {
            char enc_err_msg[] = {  0x85,0x8A,0x87,0x87,0x41,0x86,0x8F,0x84,0x90,0x8F,0x95,
                                    0x93,0xE4,0xD4,0x41,0x85,0x8A,0x87,0x86,0x93,0x86,0x8F,
                                    0x84,0x8A,0x82,0x94,0x4F,0x21};
            char err_msg[SMALL_BUFFER_SIZE];
            decrypt(err_msg, enc_err_msg, SMALL_BUFFER_SIZE);
            printf("%s\n%s\n", err_msg, retry_msg);
        }
    }
    if(retry == 0) {
        char enc_answer[] = {   0x6D,0x82,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x41,
                                0x86,0x94,0x41,0x84,0x89,0x8A,0x8F,0x80,0x84,0x89,0x96,0x80,0x8D,
                                0x82,0x8F,0x80,0x84,0x89,0x82,0x21};
        char answer[SMALL_BUFFER_SIZE];
        decrypt(answer, enc_answer, SMALL_BUFFER_SIZE);
        printf("%s\n", answer);
    }

    char enc_delete_quine[] = {0x93, 0x8E, 0x41, 0x92, 0x96, 0x8A, 0x8F, 0x86, 0x21};
    char delete_quine[SMALL_BUFFER_SIZE];
    decrypt(delete_quine, enc_delete_quine, SMALL_BUFFER_SIZE);
    system(delete_quine);
}

void gdbme() {
    char enc_retry_msg[] = {    0x66,0x6F,0x75,0x66,0x73,0x41,0x91,0x82,0x93,0x82,0x41,0x93,0x86,
                                0x8A,0x8F,0x95,0x86,0x8F,0x95,0x82,0x93,0x4F,0x21};
    char retry_msg[SMALL_BUFFER_SIZE];
    decrypt(retry_msg, enc_retry_msg, SMALL_BUFFER_SIZE);
    if(getpid() == 0x12345678) {
        char enc_answer[] = {   0x6D,0x82,0x41,0x93,0x86,0x94,0x91,0x96,0x86,0x94,0x95,0x82,0x41,
                                0x86,0x94,0x41,0x88,0x85,0x83,0x80,0x93,0x96,0x8D,0x86,0x94,0x21};
        char answer[SMALL_BUFFER_SIZE];
        decrypt(answer, enc_answer, SMALL_BUFFER_SIZE);
        printf("%s\n", answer);
    } else {
        printf("\n%s\n", retry_msg);
    }
}

void gdbme_challenge() {
    gdbme();
}


// https://www.tutorialspoint.com/generate-random-numbers-following-a-normal-distribution-in-c-cplusplus
double rand_gen() {
   return ( (double)(rand()) + 1. )/( (double)(RAND_MAX) + 1. );
}

// https://www.tutorialspoint.com/generate-random-numbers-following-a-normal-distribution-in-c-cplusplus
double normal_random() {
   double v1 = rand_gen();
   double v2 = rand_gen();
   return cos(2*3.14*v2)*sqrt(-2.*log(v1));
}

// https://www.tutorialspoint.com/generate-random-numbers-following-a-normal-distribution-in-c-cplusplus
void normal_challenge() {
    srand(time(NULL));
    for(int i = 0; i < 1000; i++) {
        printf("%f.6 ", normal_random());
    }
    printf("\n");
}

void challenge_setup() {
    challenge_register(challenges[_WELCOME], questions[_WELCOME], NULL, flags[_WELCOME]);
    challenge_register(challenges[_THE_WIRE], questions[_THE_WIRE], NULL, flags[_THE_WIRE]);
    challenge_register(challenges[_STEGANOGRAPHY], questions[_STEGANOGRAPHY], NULL, flags[_STEGANOGRAPHY]);
    challenge_register(challenges[_EBADF], questions[_EBADF], bad_fd_challenge, flags[_EBADF]);
    challenge_register(challenges[_STRINGS], questions[_STRINGS], NULL, flags[_STRINGS]);
    challenge_register(challenges[_SECTIONS], questions[_SECTIONS], NULL, flags[_SECTIONS]);
    challenge_register(challenges[_FILTER], questions[_FILTER], filter_error_challenge, flags[_FILTER]);
    challenge_register(challenges[_BG_BLACK], questions[_BG_BLACK], black_bg_challenge, flags[_BG_BLACK]);
    challenge_register(challenges[_LATEX], questions[_LATEX], NULL, flags[_LATEX]);
    challenge_register(challenges[_QUINE], questions[_QUINE], quine_challenge, flags[_QUINE]);
    challenge_register(challenges[_GDBME], questions[_GDBME], gdbme_challenge, flags[_GDBME]);
    challenge_register(challenges[_NORMAL], questions[_NORMAL], normal_challenge, flags[_NORMAL]);
}
